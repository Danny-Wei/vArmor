# The Policy Manual
English | [简体中文](policy_manual.zh_CN.md)

## Built-in Policies (WIP)
vArmor offers 5 types of built-in policies and custom interfaces to meet various protection requirements. Due to the differences between AppArmor LSM and BPF LSM, there are variations in the rules and syntax supported by different enforcers.

*Note: The built-in policies and syntax supported by different enforcers are still under development.*

| Mode | Type | Subtype | Rule Name & ID | Applicable Container | Description | Principle & Impact | Supported Enforcer |
|------|------|---------|---------------------|----------------------|-------------|--------------------|--------------------|
|**AlwaysAllow**|**Always Allow**|-|-|ALL|At container startup, no restrictions are imposed, and the configuration can be modified later, allowing dynamic adjustments to the protection policy without the need to restart workloads.|-|AppArmor<br>BPF
|**RuntimeDefault**|**Runtime Default**|-|-|Unprivileged|Basic protection is provided using the same default policy as the container runtime components (such as containerd's [cri-containerd.apparmor.d](https://github.com/containerd/containerd/blob/main/contrib/apparmor/template.go)), resulting in relatively weaker protection. (Subject to differences in mandatory access control, BPF enforcer may have some pruning compared to AppArmor enforcer)|-|AppArmor<br>BPF
|**EnhanceProtect**|**Hardening**|Securing Privileged Containers|Prohibit modifying procfs' core_pattern <br><br>`disallow-write-core-pattern`|Privileged|Attackers may attempt to directly modify the procfs core_pattern within a privileged container to escape.|Disallow writing to the procfs' core_pattern file.|AppArmor<br>BPF
|              |         |                      |Prohibit remounting procfs<br><br>`disallow-mount-procfs`|Privileged|Attackers may attempt container escape in privileged containers (with CAP_SYS_ADMIN) by remounting procfs with read-write permissions and subsequently modifying the core_pattern, among other things.|Disallow mounting of proc file systems.<br><br>When using the **AppArmor** enforcer, the bind, rbind, and remount options for mount are disabled.|AppArmor<br>BPF
|              |         |                      |Prohibit modifying cgroupfs' release_agent<br><br>`disallow-write-release-agent`|Privileged|Attackers may attempt container escape within privileged containers(w/ CAP_SYS_ADMIN) by directly modifying the cgroupfs release_agent.|Disallow writing to the cgroupfs' release_agent file.|AppArmor<br>BPF
|              |         |                      |Prohibit remounting cgroupfs<br><br>`disallow-mount-cgroupfs`|Privileged|Attackers may attempt to escape from privileged containers (w/ CAP_SYS_ADMIN) by remounting cgroupfs with read-write permissions. Subsequently, they can modify release_agent and device access permissions, among other things.|Disallow mounting cgroup file systems.<br><br>When using the **AppArmor** enforcer, the bind, rbind, and remount options for mount are disabled.|AppArmor<br>BPF
|              |         |                      |Prohibit debugging of disk devices<br><br>`disallow-debug-disk-device`|Privileged|Attackers may attempt to read and write host machine files by debugging host machine disk devices within a privileged container.|Dynamically acquire host disk devices and restrict container access them with read-write permissions.|AppArmor
|              |         |                      |Prohibit mounting of host's disk devices<br><br>`disallow-mount-disk-device`|Privileged|Attackers may attempt to mount host machine disk devices within a privileged container, thereby gaining read-write access to host machine files.|Dynamically acquire host machine disk device files and prevent mounting within containers.|AppArmor
|              |         |                      |Disable the mount system call<br><br>`disallow-mount`|ALL|[MOUNT(2)](https://man7.org/linux/man-pages/man2/mount.2.html) is often used for privilege escalation, container escapes, and other attacks. Most microservices applications do not require mount operations. Therefore, it is recommended to use this rule to restrict container processes from using the mount system call.|Disable the mount system call.|AppArmor<br>BPF
|              |         |                      |Prohibit loading kernel modules<br><br>`disallow-insmod`|Privileged|Attackers may attempt to inject code into the kernel within a privileged container (w/ CAP_SYS_MODULE) by executing kernel module loading command.|Disable CAP_SYS_MODULE|AppArmor<br>BPF
|              |         |                      |Prohibit loading eBPF programs<br><br>`disallow-load-ebpf`|ALL|Attackers may load eBPF programs within a privileged container (w/ CAP_SYS_ADMIN & CAP_BPF) to theft data or create rootkit.<br><br>Note: CAP_BPF was introduced starting from Linux 5.8.|Disable CAP_SYS_ADMIN & CAP_BPF|AppArmor<br>BPF
|              |         |                      |Prohibit accessing process's root directory<br><br>`disallow-access-procfs-root`|ALL|This policy prohibits processes within containers from accessing the root directory of the process filesystem (i.e., /proc/[PID]/root), preventing attackers from exploiting shared PID namespaces to launch attacks.<br><br>Attackers may attempt to access the process filesystem outside the container by reading and writing to /proc/*/root in environments where the PID namespace is shared with the host or other containers. This could lead to information disclosure, privilege escalation, lateral movement, and other attacks.|Disable PTRACE_MODE_READ permission |AppArmor<br>BPF
|              |         |Disable Capabilities|Disable all capabilities<br><br>`disable-cap-all`|ALL|Disable all capabilities|-|AppArmor<br>BPF
|              |         |                |Disable privileged capabilities<br><br>`disable-cap-privileged`|ALL|Disable all privileged capabilities (those that can directly lead to escapes).|-|AppArmor<br>BPF
|              |         |                |Disable specified capability<br><br>`disable-cap-XXXX`|ALL|Disable any specified capabilities, replacing XXXX with the values from 'capabilities(7),' for example, disable-cap-net-raw.|-|AppArmor<br>BPF
|              |         |Blocking Exploit Vectors|Prohibit abusing user namespaces<br><br>`disallow-abuse-user-ns`|ALL|User namespaces can be used to enhance container isolation. However, it also increases the kernel's attack surface, making certain kernel vulnerabilities easier to exploit. Attackers can use a container to create a user namespace, gaining full privileges and thereby expanding the kernel's attack surface<br><br>Disallowing container processes from obtaining CAP_SYS_ADMIN privileges via user namespaces can reduce the kernel's attack surface and block certain exploitation paths for kernel vulnerabilities.<br><br>This rule can be used to harden containers on systems where kernel.unprivileged_userns_clone=0 or user.max_user_namespace=0 is not set.| Disable CAP_SYS_ADMIN |AppArmor<br>BPF
|              |**Attack Protection**|Mitigating Information Leakage|Mitigating ServiceAccount token leakage.<br><br>`mitigate-sa-leak`|ALL|This rule prohibits container processes from reading sensitive Service Account-related information, including tokens, namespaces, and CA certificates. It helps prevent security risks arising from the leakage of Default ServiceAccount or misconfigured ServiceAccount. In the event that attackers gain access to a container through an RCE vulnerability, they often seek to further infiltrate by leaking ServiceAccount information.<br><br>In most user scenarios, there is no need for Pods to communicate with the API Server using ServiceAccounts. However, by default, Kubernetes still sets up default ServiceAccounts for Pods that do not require communication with the API Server.|Disallow reading ServiceAccount-related files.|AppArmor<br>BPF
|              |                 |             |Mitigating host disk device number leakage<br><br>`mitigate-disk-device-number-leak`|ALL|Attackers may attempt to obtain host disk device numbers for subsequent container escape by reading the container process's mount information.|Disallow reading /proc/[PID]/mountinfo and /proc/partitions files|AppArmor<br>BPF
|              |                 |             |Mitigating container overlayfs path leakage<br><br>`mitigate-overlayfs-leak`|ALL|Attackers may attempt to obtain the overlayfs path of the container's rootfs on the host by accessing the container process's mount information, which could be used for subsequent container escape.|Disallow reading /proc/mounts, /proc/[PID]/mounts, and /proc/[PID]/mountinfo files.<br><br>This rule may impact some functionality of the 'mount' command or syscall within containers|AppArmor<br>BPF
|              |                 |             |Mitigating host IP leakage<br><br>`mitigate-host-ip-leak`|ALL|After gaining access to a container through an RCE vulnerability, attackers often attempt further network penetration attacks. Therefore, restricting attackers from obtaining sensitive information such as host IP, MAC, and network segments through this vector can increase the difficulty and cost of their network penetration activities.|Disallow reading ARP address resolution tables (/proc/net/arp, /proc/[PID]/net/arp, etc.)|AppArmor<br>BPF
|              |                 |             |Disallow access to the metadata service<br><br>`disallow-metadata-service`|ALL|This rule prohibits container processes from accessing the cloud server's Instance Metadata Service, including two reserved local addresses: 100.96.0.96 and 169.254.169.254.<br><br>Attackers, upon gaining code execution privileges within a container, may attempt to access the cloud server's Metadata Service for information disclosure. In certain scenarios, attackers may obtain sensitive information, leading to privilege escalation and lateral movement.|Prohibit connections to Instance Metadata Services' IP addresses|BPF
|              |                 |Disable Sensitive Operations|Prohibit writing to the /etc directory<br><br>`disable-write-etc`|ALL|Attackers may attempt privilege escalation by modifying sensitive files in the /etc directory, such as altering /etc/bash.bashrc for watering hole attacks, editing /etc/passwd and /etc/shadow to add users for persistence, or modifying nginx.conf or /etc/ssh/ssh_config for persistence.|Disallow writing to the /etc directory|AppArmor<br>BPF
|              |                 |              |Prohibit the execution of busybox command<br><br>`disable-busybox`|ALL|Some application services are packaged using base images like busybox or Alpine. This also provides attackers with a lot of convenience, as they can use busybox to execute commands and assist in their attacks.|Prohibit the execution of busybox.<br><br>If containerized services rely on busybox or related bash commands, enabling this policy may lead to runtime errors.|AppArmor<br>BPF
|              |                 |              |Prohibit the creation of Unix shells<br><br>`disable-shell`|ALL|After gaining remote code execution privileges through an RCE vulnerability, attackers may use a reverse shell to gain arbitrary command execution capabilities within the container.<br><br>This rule prohibits container processes from creating new Unix shells, thus defending against reverse shell.|Prohibit the creation of Unix shells<br><br>Some base images may symlink sh to /bin/busybox. In this scenario, it's also necessary to prohibit the execution of busybox.|AppArmor<br>BPF
|              |                 |              |Prohibit the execution of wget command<br><br>`disable-wget`|ALL|Attackers may use the wget command to download malicious programs for subsequent attacks, such as persistence, privilege escalation, network scanning, cryptocurrency mining, and more.<br><br>This rule limits file downloads by prohibiting the execution of the wget command.|Prohibit the execution of wget<br><br>Some base images may symlink wget to /bin/busybox. In this scenario, it's also necessary to prohibit the execution of busybox.|AppArmor<br>BPF
|              |                 |              |Prohibit the execution of curl command<br><br>`disable-curl`|ALL|Attackers may use the curl command to initiate network access and download malicious programs from external sources for subsequent attacks, such as persistence, privilege escalation, network scanning, cryptocurrency mining, and more.<br><br>This rule limits network access by prohibiting the execution of the curl command.|Prohibit the execution of curl command.|AppArmor<br>BPF
|              |                 |              |Prohibit the execution of chmod command<br><br>`disable-chmod`|ALL|When attackers gain control over a container through vulnerabilities, they typically attempt to download additional attack code or tools into the container for further attacks, such as privilege escalation, lateral movement, cryptocurrency mining, and more. In this attack chain, attackers often use the chmod command to modify file permissions for execution.|Prohibit the execution of chmod command.<br><br>Some base images may symlink wget to /bin/busybox. In this scenario, it's also necessary to prohibit the execution of busybox command.|AppArmor<br>BPF
|              |                 |              |Prohibit the execution of su/sudo command<br><br>`disable-su-sudo`|ALL|When processes within a container run as non-root users, attackers often need to escalate privileges to the root user for further attacks. The sudo/su commands are common local privilege escalation avenues.|Prohibit the execution of su/sudo command.<br><br>Some base images may symlink su to /bin/busybox. In this scenario, it's also necessary to prohibit the execution of busybox command.|AppArmor<br>BPF
|              |                 |Restrict Specific Executable|-|ALL|This rule extends the use cases of 'Mitigating Information Leakage' and 'Disabling Sensitive Operations', it allows user to apply restrictions only to specific executable programs within containers.<br><br>Restricting specified executable programs serves two purposes:<br>1). Preventing sandbox policies from affecting the execution of application services within containers.<br>2).Restricting specified executable programs within containers increases the cost and difficulty for attackers<br><br>For example, this feature can be used to restrict programs like busybox, bash, sh, curl within containers, preventing attackers from using them to execute sensitive operations. Meanwhile, the application services is unaffected by sandbox policies and can continue to access ServiceAccount tokens and perform other tasks normally.<br><br>*Note: Due to the implementation principles of BPF LSM, this feature cannot be provided by the BPF enforcer.*|Enable sandbox restrictions for specified executable programs.|AppArmor
|              |**Vulnerability Mitigation**|-|Mitigate cgroups & lxcfs escape<br><br>`cgroups-lxcfs-escape-mitigation`|ALL|If users mount the host's cgroupfs into a container or use lxcfs to provide a resource view for the container, there may be a risk of container escape in both scenarios. Attackers could manipulate cgroupfs from within the container to achieve container escape.<br><br>This rule can also be used to defend against CVE-2022-0492 vulnerability exploitation.|AppArmor Enforcer prevents writing to：<br>/\*\*/release_agent, <br>/\*\*/devices/device.allow,<br>/\*\*/devices/\*\*/device.allow, <br>/\*\*/devices/cgroup.procs,<br>/\*\*/devices/\*\*/cgroup.procs,<br>/\*\*/devices/task,<br>/\*\*/devices/\*\*/task,<br><br>BPF Enforcer prevents writing to：<br>/\*\*/release_agent<br>/\*\*/devices.allow<br>/\*\*/cgroup.procs<br>/\*\*/devices/tasks<br>|AppArmor<br>BPF
||||THIS_IS_A_PLACEHOLDER_PLACEH|


## Syntax
vArmor also supports users in customizing policies based on the syntax of AppArmor enforcer and BPF enforcer.

### AppArmor enforcer
The AppArmor enforcer supports users in customizing policies based on the syntax of AppArmor.
* Refer to [syntax of security profiles for AppArmor](https://manpages.ubuntu.com/manpages/jammy/man5/apparmor.d.5.html) and [AppArmor_Core_Policy_Reference](https://gitlab.com/apparmor/apparmor/-/wikis/AppArmor_Core_Policy_Reference) for the syntax details.
* Usage:
  * Add a custom rule in .spec.policy.enhanceProtect.appArmorRawRules[]
  * Please ensure that each rule ends with a comma


### BPF enforcer (WIP)
The BPF enforcer supports users in customizing policies based on the syntax, with an upper limit of 50 rules per rule type. Each node of Kubernetes can enable sandboxing for up to 100 containers.

* File Permission
  
  | Permission / Permission Abbreviate |  Implied Permissions | Description |
  |------------------------------------|----------------------|-------------|
  |read / r|-<br>rename<br>hard link|Restrict read permission.<br>Prohibit abusing 'rename **oldpath** newpath' to bypass read restrictions on oldpath.<br>Prohibit abusing 'ln **TARGET** LINK_NAME' to bypass read restrictions on TARGET.
  |write / w|-<br>append<br>rename<br>hard link<br>symbol link<br>chmod<br>chown|Restrict write permission.<br>Prohibit using the O_APPEND flag to bypass map_file_to_perms() for append operations.<br>Prohibit abusing 'rename oldpath **newpath**' to bypass write restrictions on newpath.<br>Prohibit abusing 'ln TARGET **LINK_NAME**' to bypass write restrictions on LINK_NAME.<br>Prohibit abusing symlink to bypass write restrictions on the target file.<br>WIP<br>WIP
  |exec / x|-|Prohibit execution permission.
  |append / a|-|Prohibit append permission.

* File Globbing Syntax 
  | Globbing | Description | Examples | Notes |
  |----------|-------------|----------|-------|
  |*|- Used only to match file names.<br>- It will match dot files except the special dot files . and ..<br>- Supports only a single *, and does not support \*\* and * appearing together.|- fi\* matches any file name starting with 'fi'.<br>- *le matches any file name ending with 'le'.<br>- *.log matches any file name ending with '.log'|The behavior of this globbing may change in future versions.|
  |\**|- Match zero, one, or multiple characters in multi-level directories.<br>- It will match dot files except the special dot files . and ..<br>- Supports only a single \*\*, and does not support ** and * appearing together.|- /tmp/\*\*/33 matches any file that starts with /tmp and ends with /33, including /tmp/33.<br>- /tmp/\*\* matches any file or directory that starts with /tmp.<br>- /tm** matches any file or directory that starts with /tm.<br>- /t**/33 matches any file or directory that starts with /t and ends with /33.

* Network Permission
  * Currently, vArmor supports connection access control for specified IP addresses, IP address blocks (CIDR blocks), and ports.
  * When specific IP addresses or IP address blocks are specified without specifying ports, it defaults to affecting all ports.
  * Please refer to [NetworkEgressRule](./interface_instructions.md#networkegressrule) for specific details.
